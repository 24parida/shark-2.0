build-win:
  name: Build on Windows (MSYS2/MinGW)
  runs-on: windows-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 1) Set up MSYS2 without triggering the full upgrade
    - name: Set up MSYS2 & install toolchain
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false               # ← skip pacman -Syuu
        install: >
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-fltk
          mingw-w64-x86_64-tbb
          mingw-w64-x86_64-cmake
          make

    # 2) (Optional) if you want to refresh the DB in CI—won't kill the shell if you split it:
    #- name: Refresh MSYS2 package DB
    #  shell: msys2 {0}
    #  run: |
    #    pacman -Sy --noconfirm

    # 3) Configure & build under MSYS2
    - name: Configure & build
      shell: msys2 {0}
      run: |
        mkdir -p build
        cd build
        cmake -G "MinGW Makefiles" .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_STANDARD=20 \
          -DCMAKE_CXX_EXTENSIONS=OFF \
          -DCMAKE_CXX_FLAGS="-O3 -ffast-math"
        make -j

    - name: List build artifacts
      shell: msys2 {0}
      run: ls -R build

    - name: Upload shark.exe
      uses: actions/upload-artifact@v4
      with:
        name: shark-windows-mingw
        path: build/shark.exe
